<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SYSTEM ‚Äî Solo Leveling</title>

    <!-- Force clear old service worker cache (one-time purge) -->
    <script>
        (function(){
            if ('serviceWorker' in navigator && !sessionStorage.getItem('sw_purged_v32')) {
                navigator.serviceWorker.getRegistrations().then(function(regs) {
                    var hadOld = false;
                    regs.forEach(function(r) { r.unregister(); hadOld = true; });
                    if ('caches' in window) {
                        caches.keys().then(function(names) {
                            names.forEach(function(n) { caches.delete(n); });
                        });
                    }
                    sessionStorage.setItem('sw_purged_v32', '1');
                    if (hadOld) { setTimeout(function(){ location.reload(true); }, 500); }
                });
            }
        })();
    </script>

    <!-- PWA Meta -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#020510">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SYSTEM">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="SYSTEM">
    <meta name="msapplication-TileColor" content="#04060e">
    <meta name="msapplication-TileImage" content="icons/icon-144.png">

    <!-- Icons -->
    <link rel="apple-touch-icon" href="icons/icon-152.png">
    <link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-96.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">

    <!-- Fonts & Styles -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Share+Tech+Mono&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/main.css?v=32">
    <link rel="stylesheet" href="css/panels.css?v=32">
    <link rel="stylesheet" href="css/animations.css?v=32">
    <link rel="stylesheet" href="css/features.css?v=32">
    <link rel="stylesheet" href="css/mobile.css?v=32">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase SDKs (compat mode for vanilla JS) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-particles"></div>
        <div class="login-box">
            <div class="login-glitch" data-text="SYSTEM">SYSTEM</div>
            <div class="login-line"></div>
            <div class="login-subtitle">HUNTER IDENTIFICATION REQUIRED</div>

            <button id="googleSignInBtn" class="login-btn login-btn-google">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="google-icon" alt="">
                Sign in with Google
            </button>

            <div class="login-divider">
                <span class="login-divider-line"></span>
                <span class="login-divider-text">OR</span>
                <span class="login-divider-line"></span>
            </div>

            <div class="login-guest">
                <input type="text" id="guestNameInput" class="login-input" placeholder="Enter Hunter Name..." maxlength="24" autocomplete="off">
                <button id="guestSignInBtn" class="login-btn login-btn-guest">[ENTER AS GUEST]</button>
            </div>

            <p id="loginError" class="login-error hidden"></p>

            <div class="login-footer">
                <p class="login-note">‚ö° Google sign-in syncs progress across devices</p>
                <p class="login-note">üë§ Guest mode saves locally only</p>
            </div>
        </div>
    </div>

    <!-- Boot Screen -->
    <div id="bootScreen" class="boot-screen hidden">
        <div class="boot-content">
            <div class="boot-glitch" data-text="SYSTEM">SYSTEM</div>
            <div class="boot-line"></div>
            <div class="boot-text">
                <p id="bootMsg1" class="boot-msg">[Detecting life signs... confirmed.]</p>
                <p id="bootMsg2" class="boot-msg">[Candidate qualifies for the Program.]</p>
                <p id="bootMsg3" class="boot-msg">[Binding System to Player...]</p>
                <p id="bootMsg4" class="boot-msg">[Awakening complete.]</p>
            </div>
            <button id="bootEnter" class="boot-enter hidden">[ENTER THE SYSTEM]</button>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="main-app hidden">
        <!-- Floating Particles -->
        <canvas id="particleCanvas" class="particle-canvas"></canvas>

        <!-- System Header -->
        <header class="sys-header">
            <div class="sys-logo">
                <span class="sys-bracket">[</span>
                <span class="sys-title">S Y S T E M</span>
                <span class="sys-bracket">]</span>
                <span id="syncIndicator" class="sync-indicator sync-saved" title="Cloud sync">‚òÅ</span>
            </div>
            <div class="header-quick">
                <div class="hq-item hq-user">
                    <img id="userAvatar" class="user-avatar" src="" alt="" style="display:none">
                    <span id="userDisplayName" class="user-name"></span>
                </div>
                <div class="hq-item">
                    <span class="hq-label">LV</span>
                    <span class="hq-val" id="hqLevel">1</span>
                </div>
                <div class="hq-item rank-badge" id="hqRankBadge">
                    <span class="hq-val" id="hqRank">E</span>
                </div>
                <div class="hq-item">
                    <span class="hq-label">GOLD</span>
                    <span class="hq-val gold-text" id="hqGold">0</span>
                </div>
                <button id="linkGoogleBtn" class="hq-link-btn hidden" title="Link Google Account">üîó</button>
                <button id="soundToggleBtn" class="hq-sound-btn" title="Toggle Sound">üîä</button>
                <button id="signOutBtn" class="hq-signout-btn" title="Sign Out">‚èª</button>
            </div>
        </header>

        <!-- XP Bar -->
        <div class="xp-bar-wrap">
            <div class="xp-info">
                <span>EXP</span>
                <span id="xpText">0 / 120</span>
            </div>
            <div class="xp-track">
                <div class="xp-fill" id="xpFill"></div>
                <div class="xp-shine"></div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <nav class="tab-nav">
            <button class="tab active" data-tab="status"><span class="tab-icon">‚óà</span> Status</button>
            <button class="tab" data-tab="gates"><span class="tab-icon">‚¨°</span> Daily Gate</button>
            <button class="tab" data-tab="log"><span class="tab-icon">‚¨¢</span> Log</button>
            <button class="tab" data-tab="shop"><span class="tab-icon">‚¨ü</span> Shop</button>
            <button class="tab" data-tab="skills"><span class="tab-icon">‚óá</span> Skills</button>
            <button class="tab" data-tab="analysis"><span class="tab-icon">‚ñ≥</span> Analysis</button>
            <button class="tab" data-tab="journal"><span class="tab-icon">üìñ</span> Journal</button>
            <button class="tab" data-tab="tutorial"><span class="tab-icon">ÔøΩ</span> Guide</button>
        </nav>

        <!-- ===== STATUS TAB ===== -->
        <section class="panel active" data-panel="status">
            <div class="sys-window">
                <div class="sw-header">[Status Window]</div>
                <div class="sw-body">
                    <div class="sw-row"><span class="sw-key">Player</span><span class="sw-val" id="playerName">Hunter</span></div>
                    <div class="sw-row"><span class="sw-key">Level</span><span class="sw-val" id="swLevel">1</span></div>
                    <div class="sw-row"><span class="sw-key">Rank</span><span class="sw-val" id="swRank">E-Rank</span></div>
                    <div class="sw-row"><span class="sw-key">Title</span><span class="sw-val" id="swTitle">The Weakest Hunter</span></div>
                    <div class="sw-row"><span class="sw-key">Weapon</span><span class="sw-val" id="swWeapon">‚Äî</span></div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card" data-stat="str">
                    <div class="sc-icon">‚öî</div>
                    <div class="sc-name">STR</div>
                    <div class="sc-val" id="statSTR">5</div>
                    <div class="sc-bar"><div class="sc-fill" id="barSTR"></div></div>
                </div>
                <div class="stat-card" data-stat="agi">
                    <div class="sc-icon">‚ö°</div>
                    <div class="sc-name">AGI</div>
                    <div class="sc-val" id="statAGI">4</div>
                    <div class="sc-bar"><div class="sc-fill" id="barAGI"></div></div>
                </div>
                <div class="stat-card" data-stat="vit">
                    <div class="sc-icon">‚ô•</div>
                    <div class="sc-name">VIT</div>
                    <div class="sc-val" id="statVIT">5</div>
                    <div class="sc-bar"><div class="sc-fill" id="barVIT"></div></div>
                </div>
                <div class="stat-card" data-stat="end">
                    <div class="sc-icon">‚óâ</div>
                    <div class="sc-name">END</div>
                    <div class="sc-val" id="statEND">4</div>
                    <div class="sc-bar"><div class="sc-fill" id="barEND"></div></div>
                </div>
                <div class="stat-card" data-stat="wil">
                    <div class="sc-icon">‚ò¨</div>
                    <div class="sc-name">WIL</div>
                    <div class="sc-val" id="statWIL">3</div>
                    <div class="sc-bar"><div class="sc-fill" id="barWIL"></div></div>
                </div>
                <div class="stat-card" data-stat="phs">
                    <div class="sc-icon">‚òâ</div>
                    <div class="sc-name">PHS</div>
                    <div class="sc-val" id="statPHS">3.0</div>
                    <div class="sc-bar"><div class="sc-fill phs-fill" id="barPHS"></div></div>
                </div>
            </div>

            <!-- Free stat points -->
            <div class="stat-points-panel hidden" id="statPointsPanel">
                <div class="sw-header">[Distribute Stat Points]</div>
                <div class="sp-available">Available: <span id="freePoints">0</span></div>
                <div class="sp-grid">
                    <button class="sp-btn" data-alloc="str">STR +1</button>
                    <button class="sp-btn" data-alloc="agi">AGI +1</button>
                    <button class="sp-btn" data-alloc="vit">VIT +1</button>
                    <button class="sp-btn" data-alloc="end">END +1</button>
                    <button class="sp-btn" data-alloc="wil">WIL +1</button>
                    <button class="sp-btn" data-alloc="phs">PHS +1</button>
                </div>
            </div>

            <!-- Physique Goals -->
            <div class="sys-window mt">
                <div class="sw-header">[Physique Tracker]</div>
                <div class="sw-body">
                    <div class="phys-form" id="physForm">
                        <div class="pf-row">
                            <label>Current Weight (kg)</label>
                            <input type="number" id="pCurWeight" step="0.1">
                        </div>
                        <div class="pf-row">
                            <label>Target Weight (kg)</label>
                            <input type="number" id="pTarWeight" step="0.1">
                        </div>
                        <button class="sys-btn" id="savePhysBtn">[UPDATE]</button>
                    </div>
                    <div id="physProgress" class="phys-prog"></div>
                </div>
            </div>

            <!-- Body Fat Analyzer -->
            <div class="sys-window mt">
                <div class="sw-header">[Body Composition Analyzer]</div>
                <div class="sw-body">
                    <div class="bf-form" id="bfForm">
                        <div class="bf-row-group">
                            <div class="bf-row">
                                <label>Gender</label>
                                <select id="bfGender">
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                </select>
                            </div>
                            <div class="bf-row">
                                <label>Height (cm)</label>
                                <input type="number" id="bfHeight" step="0.1" min="100" max="250" placeholder="e.g. 175">
                            </div>
                        </div>
                        <div class="bf-row-group">
                            <div class="bf-row">
                                <label>Age</label>
                                <input type="number" id="bfAge" min="13" max="80" placeholder="e.g. 22">
                            </div>
                            <div class="bf-row">
                                <label>Activity Level</label>
                                <select id="bfActivity">
                                    <option value="1.2">Sedentary (desk job)</option>
                                    <option value="1.375">Light (1-3√ó/week)</option>
                                    <option value="1.55" selected>Moderate (3-5√ó/week)</option>
                                    <option value="1.725">Active (6-7√ó/week)</option>
                                    <option value="1.9">Athlete (2√ó/day)</option>
                                </select>
                            </div>
                        </div>
                        <div class="bf-row-group">
                            <div class="bf-row">
                                <label>Neck (cm)</label>
                                <input type="number" id="bfNeck" step="0.1" min="20" max="60" placeholder="e.g. 38">
                            </div>
                            <div class="bf-row">
                                <label>Waist (cm)</label>
                                <input type="number" id="bfWaist" step="0.1" min="40" max="200" placeholder="e.g. 82">
                            </div>
                        </div>
                        <div class="bf-row-group bf-hip-row" id="bfHipRow">
                            <div class="bf-row">
                                <label>Hip (cm) <small>(females)</small></label>
                                <input type="number" id="bfHip" step="0.1" min="50" max="200" placeholder="e.g. 95">
                            </div>
                        </div>
                        <div class="bf-method-note">Using U.S. Navy Method + BMI Analysis</div>
                        <button class="sys-btn" id="calcBfBtn">[ANALYZE BODY COMPOSITION]</button>
                    </div>
                    <div id="bfResults" class="bf-results"></div>
                    <div id="bfHistory" class="bf-history"></div>
                </div>
            </div>

            <!-- Ancient Wisdom -->
            <div class="wisdom-box" id="wisdomBox">
                <div class="wb-label">‚Äî Words of the Departed Monarchs ‚Äî</div>
                <div class="wb-text" id="wisdomText">"The body breaks before the will ‚Äî forge the latter in fire."</div>
            </div>

            <!-- Rank Avatar -->
            <div id="avatarContainer" class="avatar-wrap"></div>

            <!-- Shadow Army -->
            <div class="army-window" id="armySection">
                <div class="army-header">‚ò¨ SHADOW ARMY</div>
                <div class="army-body">
                    <div class="army-icon">üë§</div>
                    <div class="army-info">
                        <div class="army-count" id="armyCount">0</div>
                        <div class="army-rank-name" id="armyRankName">No Shadows</div>
                    </div>
                    <div class="army-visual" id="armyVisual"></div>
                </div>
            </div>
        </section>

        <!-- ===== DAILY GATE TAB ===== -->
        <section class="panel" data-panel="gates">
            <div class="sys-window">
                <div class="sw-header">[Daily Gate ‚Äî <span id="gateDate"></span>]</div>
                <div class="gate-meta">
                    <div class="gm-item">
                        <span class="gm-icon">üî•</span>
                        <span class="gm-val" id="streakVal">0</span>
                        <span class="gm-label">Day Streak</span>
                    </div>
                    <div class="gm-item">
                        <span class="gm-icon">‚óà</span>
                        <span class="gm-val" id="gateProgress">0/5</span>
                        <span class="gm-label">Cleared</span>
                    </div>
                    <div class="gm-item penalty-box" id="penaltyIndicator">
                        <span class="gm-icon">‚ò†</span>
                        <span class="gm-val" id="penaltyCount">0</span>
                        <span class="gm-label">Penalties</span>
                    </div>
                </div>
            </div>

            <div class="quest-list" id="questList"></div>

            <!-- Weekly Muscle Coverage -->
            <div class="sys-window mt" id="muscleCoveragePanel">
                <div class="sw-header">[Weekly Muscle Coverage ‚Äî Train Each Group 2√ó/Week]</div>
                <div id="muscleCoverageGrid" class="muscle-coverage-grid"></div>
            </div>

            <div class="gate-bonus" id="gateBonusBox">
                <span class="gb-icon">‚óÜ</span>
                <span>Clear all gates: <strong id="gateBonusText">+150 Bonus XP, +50 Gold</strong></span>
            </div>

            <!-- Penalty Log -->
            <div class="sys-window mt" id="penaltySection">
                <div class="sw-header penalty-header">[Penalty Record]</div>
                <div id="penaltyLog" class="penalty-log"></div>
            </div>

            <!-- Weekly Boss Raid -->
            <div class="boss-window" id="bossSection">
                <div class="boss-header">
                    <span class="boss-header-title">‚ò† WEEKLY BOSS RAID</span>
                    <span class="boss-rank" id="bossRankLabel">‚Äî</span>
                </div>
                <div class="boss-body" id="bossBody">
                    <div class="boss-icon" id="bossIcon"></div>
                    <div class="boss-name" id="bossName">Loading‚Ä¶</div>
                    <div class="boss-hp-info">
                        <span>HP</span>
                        <span id="bossHpText">0 / 0</span>
                    </div>
                    <div class="boss-hp-track">
                        <div class="boss-hp-fill" id="bossHpFill" style="width:100%"></div>
                    </div>
                    <div class="boss-damage-hint">[Log workouts to deal damage]</div>
                </div>
            </div>
        </section>

        <!-- ===== LOG TAB ===== -->
        <section class="panel" data-panel="log">
            <!-- Workout Templates -->
            <div class="sys-window">
                <div class="sw-header">[Workout Templates ‚Äî Quick Log]</div>
                <div id="templatesContent" class="templates-content"></div>
            </div>

            <!-- Workout Log -->
            <div class="sys-window">
                <div class="sw-header">[Report ‚Äî Workout]</div>
                <div class="log-form">
                    <div class="lf-row">
                        <label>Muscle Group</label>
                        <div class="exercise-filter-bar" id="exerciseFilterBar">
                            <button class="ef-pill active" data-group="All">All</button>
                        </div>
                    </div>
                    <div class="lf-row">
                        <label>Exercise</label>
                        <select id="logExercise">
                            <option value="">‚Äî Select ‚Äî</option>
                        </select>
                    </div>
                    <div class="lf-two">
                        <div class="lf-row">
                            <label>Reps / Duration (min)</label>
                            <input type="number" id="logReps" min="1">
                        </div>
                        <div class="lf-row">
                            <label>Sets / Rounds</label>
                            <input type="number" id="logSets" min="1" value="1">
                        </div>
                    </div>
                    <div class="lf-row">
                        <label>Weight Used (kg) <small>(optional)</small></label>
                        <input type="number" id="logWeight" step="0.5" min="0">
                    </div>
                    <div class="lf-row">
                        <label>Intensity</label>
                        <select id="logIntensity">
                            <option value="low">Low ‚Äî Warm-up pace</option>
                            <option value="medium" selected>Medium ‚Äî Working effort</option>
                            <option value="high">High ‚Äî Near max effort</option>
                        </select>
                    </div>
                    <button class="sys-btn" id="submitWorkout">[REPORT WORKOUT]</button>
                </div>
            </div>

            <!-- Food Log -->
            <div class="sys-window mt">
                <div class="sw-header">[Report ‚Äî Sustenance]</div>
                <div class="log-form">
                    <div class="lf-two">
                        <div class="lf-row food-autocomplete-wrap">
                            <label>Food Item</label>
                            <input type="text" id="logFood" placeholder="Type to search..." autocomplete="off">
                            <div class="food-suggestions hidden" id="foodSuggestions"></div>
                        </div>
                        <div class="lf-row">
                            <label>Meal</label>
                            <select id="logMeal">
                                <option value="Breakfast">Breakfast</option>
                                <option value="Lunch">Lunch</option>
                                <option value="Dinner">Dinner</option>
                                <option value="Snack">Snack</option>
                                <option value="Pre-Workout">Pre-Workout</option>
                                <option value="Post-Workout">Post-Workout</option>
                            </select>
                        </div>
                    </div>
                    <div class="lf-row">
                        <label>Servings <small id="servingHint"></small></label>
                        <input type="number" id="logServings" min="0.25" step="0.25" value="1">
                    </div>
                    <div class="lf-three">
                        <div class="lf-row">
                            <label>Protein (g)</label>
                            <input type="number" id="logProtein" min="0" step="0.1">
                        </div>
                        <div class="lf-row">
                            <label>Carbs (g)</label>
                            <input type="number" id="logCarbs" min="0" step="0.1">
                        </div>
                        <div class="lf-row">
                            <label>Fats (g)</label>
                            <input type="number" id="logFats" min="0" step="0.1">
                        </div>
                    </div>
                    <div class="cal-preview">
                        <span>[Auto-calculated]</span>
                        <span class="cal-val" id="calPreview">0 kcal</span>
                    </div>
                    <button class="sys-btn" id="submitFood">[REPORT SUSTENANCE]</button>
                </div>
            </div>

            <!-- Energy Balance ‚Äî Intake vs Output -->
            <div class="sys-window mt" id="energyBalanceSection">
                <div class="sw-header">[Energy Balance ‚Äî Intake vs Output]</div>
                <div class="energy-balance" id="energyBalance"></div>
            </div>

            <!-- Today Feed -->
            <div class="sys-window mt">
                <div class="sw-header">[Today's Report Log]</div>
                <div id="todayFeed" class="today-feed"></div>
            </div>
        </section>

        <!-- ===== SHOP TAB ===== -->
        <section class="panel" data-panel="shop">
            <!-- Equipped Gear Display -->
            <div class="sys-window shop-equipped-window">
                <div class="sw-header">[Equipped Gear]</div>
                <div class="sw-body">
                    <div id="equippedWeaponDisplay" class="equipped-display">
                        <div class="equipped-empty">No gear equipped</div>
                    </div>
                </div>
            </div>

            <!-- Shop Header -->
            <div class="shop-header-panel mt">
                <div class="shop-banner">
                    <div class="shop-banner-icon">‚öî</div>
                    <div class="shop-banner-text">
                        <div class="shop-banner-title">HUNTER'S ARMORY</div>
                        <div class="shop-banner-sub">Trophies of your evolution. Proof you rose from the ashes.</div>
                    </div>
                </div>
                <div class="shop-stats-row">
                    <div class="shop-stat">
                        <span class="shop-stat-icon">üí∞</span>
                        <span class="shop-stat-val gold-text" id="shopGoldDisplay">0</span>
                        <span class="shop-stat-label">Gold</span>
                    </div>
                    <div class="shop-stat">
                        <span class="shop-stat-icon">üì¶</span>
                        <span class="shop-stat-val" id="shopCollectionCount">0/0</span>
                        <span class="shop-stat-label">Collected</span>
                    </div>
                </div>
                <div class="shop-daily-limits" id="shopDailyLimits">
                    <span class="shop-limit-tag" id="shopLimitBuy">üõí Buy: 5/5</span>
                    <span class="shop-limit-tag" id="shopLimitUse">üß™ Use: 3/3</span>
                </div>
            </div>

            <!-- Shop Filters -->
            <div class="shop-filters mt">
                <button class="shop-filter-btn active" data-filter="all">ALL</button>
                <button class="shop-filter-btn" data-filter="weapon">‚öî Weapons</button>
                <button class="shop-filter-btn" data-filter="armor">üõ° Armor</button>
                <button class="shop-filter-btn" data-filter="potion">üß™ Potions</button>
                <button class="shop-filter-btn" data-filter="artifact">üíé Artifacts</button>
                <button class="shop-filter-btn" data-filter="relic">üíç Relics</button>
                <button class="shop-filter-btn" data-filter="scroll">üìú Scrolls</button>
            </div>

            <!-- Shop Items Grid -->
            <div class="shop-grid" id="shopContent" data-filter="all"></div>
        </section>

        <!-- ===== SKILLS TAB ===== -->
        <section class="panel" data-panel="skills">
            <div class="sys-window">
                <div class="sw-header">[Skills & Perks]</div>
                <div id="skillsList" class="skills-list"></div>
            </div>

            <div class="sys-window mt">
                <div class="sw-header">[Achievements]</div>
                <div id="achieveList" class="achieve-list"></div>
            </div>
        </section>

        <!-- ===== ANALYSIS TAB ===== -->
        <section class="panel" data-panel="analysis">
            <!-- Dungeon Calendar Heatmap -->
            <div class="sys-window">
                <div class="sw-header">[Dungeon Calendar ‚Äî Gate Activity]</div>
                <div class="heatmap-container">
                    <div class="heatmap-year-nav">
                        <button class="heatmap-nav-btn" id="heatmapPrev">‚óÄ</button>
                        <span class="heatmap-year" id="heatmapYear">2026</span>
                        <button class="heatmap-nav-btn" id="heatmapNext">‚ñ∂</button>
                    </div>
                    <div class="heatmap-stats">
                        <span class="heatmap-stat"><span class="heatmap-stat-val" id="hmTotalDays">0</span> days active</span>
                        <span class="heatmap-stat"><span class="heatmap-stat-val" id="hmTotalXP">0</span> total XP</span>
                        <span class="heatmap-stat">üî• <span class="heatmap-stat-val" id="hmStreak">0</span> streak</span>
                    </div>
                    <div class="heatmap-months" id="heatmapMonths"></div>
                    <div class="heatmap-grid-wrap">
                        <div class="heatmap-day-labels">
                            <span></span><span>Mon</span><span></span><span>Wed</span><span></span><span>Fri</span><span></span>
                        </div>
                        <div class="heatmap-grid" id="heatmapGrid"></div>
                    </div>
                    <div class="heatmap-legend">
                        <span class="heatmap-legend-label">Less</span>
                        <span class="heatmap-cell-legend hm-lv0"></span>
                        <span class="heatmap-cell-legend hm-lv1"></span>
                        <span class="heatmap-cell-legend hm-lv2"></span>
                        <span class="heatmap-cell-legend hm-lv3"></span>
                        <span class="heatmap-cell-legend hm-lv4"></span>
                        <span class="heatmap-legend-label">More</span>
                    </div>
                    <div class="heatmap-tooltip hidden" id="heatmapTooltip"></div>
                </div>
            </div>

            <div class="sys-window mt">
                <div class="sw-header">[Progress Analysis ‚Äî 7 Day]</div>
                <div class="chart-wrap"><canvas id="chartXP"></canvas></div>
            </div>
            <div class="sys-window mt">
                <div class="sw-header">[Calorie Intel]</div>
                <div class="chart-wrap"><canvas id="chartCal"></canvas></div>
            </div>
            <div class="sys-window mt">
                <div class="sw-header">[Macro Breakdown ‚Äî Today]</div>
                <div class="chart-wrap chart-small"><canvas id="chartMacro"></canvas></div>
            </div>
            <div class="sys-window mt">
                <div class="sw-header">[Lifetime Record]</div>
                <div class="lifetime-grid">
                    <div class="lt-item"><span class="lt-val" id="ltWorkouts">0</span><span class="lt-label">Workouts</span></div>
                    <div class="lt-item"><span class="lt-val" id="ltCalBurned">0</span><span class="lt-label">Cal Burned</span></div>
                    <div class="lt-item"><span class="lt-val" id="ltCalEaten">0</span><span class="lt-label">Cal Consumed</span></div>
                    <div class="lt-item"><span class="lt-val" id="ltMeals">0</span><span class="lt-label">Meals Logged</span></div>
                    <div class="lt-item"><span class="lt-val" id="ltQuests">0</span><span class="lt-label">Quests Done</span></div>
                    <div class="lt-item"><span class="lt-val" id="ltDays">0</span><span class="lt-label">Days Active</span></div>
                    <div class="lt-item"><span class="lt-val" id="ltShadowMissions">0</span><span class="lt-label">Shadow Missions</span></div>
                    <div class="lt-item"><span class="lt-val" id="ltBosses">0</span><span class="lt-label">Bosses Slain</span></div>
                </div>
            </div>

            <!-- Data Management -->
            <div class="sys-window mt">
                <div class="sw-header">[Data Management]</div>
                <div class="data-mgmt">
                    <button class="sys-btn dm-btn" id="btnExport">‚¨á Export Save</button>
                    <button class="sys-btn dm-btn" id="btnImport">‚¨Ü Import Save</button>
                    <button class="sys-btn dm-btn dm-danger" id="btnReset" onclick="handleResetData()">‚ò† Reset All Data</button>
                </div>
            </div>

            <!-- Notification Settings -->
            <div class="sys-window mt">
                <div class="sw-header">[System Notifications]</div>
                <div class="notif-settings">
                    <div class="notif-row">
                        <span class="notif-label">üîî Training Reminders</span>
                        <button class="notif-toggle-btn" id="notifToggleBtn" onclick="toggleNotifications()">
                            <span class="notif-toggle-status" id="notifToggleStatus">OFF</span>
                        </button>
                    </div>
                    <div class="notif-row" id="notifTimeRow" style="display:none">
                        <span class="notif-label">‚è∞ Reminder Time</span>
                        <select class="notif-time-select" id="notifTimeSelect" onchange="setNotifTime(this.value)">
                            <option value="7">7:00 AM</option>
                            <option value="8">8:00 AM</option>
                            <option value="9">9:00 AM</option>
                            <option value="10">10:00 AM</option>
                            <option value="12">12:00 PM</option>
                            <option value="14">2:00 PM</option>
                            <option value="16">4:00 PM</option>
                            <option value="18" selected>6:00 PM</option>
                            <option value="19">7:00 PM</option>
                            <option value="20">8:00 PM</option>
                            <option value="21">9:00 PM</option>
                        </select>
                    </div>
                    <div class="notif-hint" id="notifHint">Enable to receive daily "System" reminders to train</div>
                </div>
            </div>
        </section>

        <!-- ===== JOURNAL TAB ===== -->
        <section class="panel" data-panel="journal">
            <div id="journalContent"></div>
        </section>

        <!-- ===== TUTORIAL TAB ===== -->
        <section class="panel" data-panel="tutorial">
            <div id="tutorialContent"></div>
        </section>

        <!-- System Notification -->
        <div id="sysNotif" class="sys-notif"></div>

        <!-- Level Up Overlay -->
        <div id="levelUpOverlay" class="level-up-overlay hidden">
            <div class="lu-box">
                <div class="lu-flash"></div>
                <div class="lu-label">LEVEL UP</div>
                <div class="lu-level" id="luLevel">2</div>
                <div class="lu-sub" id="luSub">+4 free stat points</div>
                <div class="lu-wisdom" id="luWisdom"></div>
                <button class="sys-btn" id="luClose">[CONTINUE]</button>
            </div>
        </div>

        <!-- Shadow Mission Overlay -->
        <div id="shadowMissionOverlay" class="sm-overlay hidden">
            <div class="sm-box sm-entrance">
                <div class="sm-alert">‚ö† EMERGENCY QUEST ‚ö†</div>
                <div class="sm-title" id="smTitle"></div>
                <div class="sm-desc" id="smDesc"></div>
                <div class="sm-reward" id="smReward"></div>
                <div class="sm-timer-wrap">
                    <div class="sm-timer-track"><div class="sm-timer-fill" id="smTimerFill" style="width:100%"></div></div>
                    <div class="sm-timer-text" id="smTimer">--:--</div>
                </div>
                <div class="sm-buttons">
                    <button class="sm-btn-accept" id="smComplete">[MISSION COMPLETE]</button>
                    <button class="sm-btn-skip" id="smSkip">[SKIP]</button>
                </div>
            </div>
        </div>

        <!-- Login Reward Overlay -->
        <div id="loginRewardOverlay" class="lr-overlay hidden">
            <div class="lr-box">
                <div class="lr-title">DAILY LOGIN REWARD</div>
                <div class="lr-streak" id="lrStreak">Day 1</div>
                <div class="lr-grid" id="lrGrid"></div>
                <div class="lr-reward" id="lrReward"></div>
                <button class="sys-btn" id="lrClose">[CLAIM]</button>
            </div>
        </div>

        <!-- Template Creator Overlay -->
        <div id="templateCreatorOverlay" class="tpl-creator-overlay hidden">
            <div class="tpl-creator-box">
                <div class="tpl-creator-title">‚öô CREATE TEMPLATE</div>
                <div class="tpl-creator-form">
                    <div class="lf-row">
                        <label>Template Name</label>
                        <input type="text" id="tplCreatorName" placeholder="e.g. My Push Day" maxlength="30" autocomplete="off">
                    </div>
                    <div class="lf-row">
                        <label>Add Exercise</label>
                        <div class="tpl-creator-add">
                            <select id="tplCreatorExercise"></select>
                            <button class="tpl-creator-add-btn" onclick="addCreatorExercise()">+</button>
                        </div>
                    </div>
                    <div id="tplCreatorList" class="tpl-creator-list"></div>
                    <div class="tpl-creator-actions">
                        <button class="sys-btn" onclick="saveCustomTemplate()">[SAVE TEMPLATE]</button>
                        <button class="sys-btn dm-danger" onclick="closeTemplateCreator()">[CANCEL]</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Decay Report Overlay -->
        <div id="decayOverlay" class="decay-overlay hidden">
            <div class="decay-box">
                <div class="decay-glitch">‚ö† SYSTEM PENALTY ‚ö†</div>
                <div class="decay-title" id="decayTitle">YOU WERE ABSENT</div>
                <div class="decay-subtitle" id="decaySubtitle">The System does not forgive. The System does not forget.</div>
                <div class="decay-losses" id="decayLosses"></div>
                <div class="decay-quote">"Every day you skip, the shadows grow ‚Äî but not yours."</div>
                <button class="sys-btn decay-close-btn" id="decayClose">[ACCEPT PUNISHMENT]</button>
            </div>
        </div>

    </div>

    <!-- Reset Confirm Modal (outside mainApp so it always works) -->
    <div id="resetOverlay" class="reset-overlay hidden">
        <div class="reset-box">
            <div class="reset-icon">‚ò†</div>
            <div class="reset-title">SYSTEM WIPE</div>
            <div class="reset-msg" id="resetMsg">‚ö† WARNING: This will erase ALL progress. Your rank, stats, quests, and history will be permanently destroyed. This cannot be undone.</div>
            <div class="reset-buttons">
                <button class="sys-btn reset-btn-danger" id="resetConfirm" onclick="confirmReset()">[DESTROY ALL DATA]</button>
                <button class="sys-btn reset-btn-cancel" id="resetCancel" onclick="cancelReset()">[CANCEL]</button>
            </div>
        </div>
    </div>

    <script src="js/firebase-config.js?v=32"></script>
    <script src="js/auth.js?v=32"></script>
    <script src="js/db.js?v=32"></script>
    <script src="js/data.js?v=32"></script>
    <script src="js/sounds.js?v=32"></script>
    <script src="js/engine.js?v=32"></script>
    <script src="js/quests.js?v=32"></script>
    <script src="js/shop.js?v=32"></script>
    <script src="js/ui.js?v=32"></script>
    <script src="js/charts.js?v=32"></script>
    <script src="js/features.js?v=32"></script>
    <script src="js/tutorial.js?v=32"></script>
    <script src="js/journal.js?v=32"></script>
    <script src="js/templates.js?v=32"></script>
    <script src="js/avatar.js?v=32"></script>
    <script src="js/app.js?v=32"></script>

    <!-- PWA Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js', { updateViaCache: 'none' })
                    .then(reg => {
                        console.log('[System] Service Worker registered.', reg.scope);
                        // Force update check immediately
                        reg.update();
                        // If a new SW is waiting, tell it to activate now
                        if (reg.waiting) {
                            reg.waiting.postMessage({ type: 'SKIP_WAITING' });
                        }
                        reg.addEventListener('updatefound', () => {
                            const newWorker = reg.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'activated') {
                                    console.log('[System] New SW activated, reloading...');
                                    window.location.reload();
                                }
                            });
                        });
                    })
                    .catch(err => console.log('[System] SW registration failed:', err));
            });
        }
    </script>
</body>
</html>
